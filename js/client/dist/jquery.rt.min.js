/*
 *  jQuery Reading Tools - v0.0.1
 *  Reading tools: make reading on-screen something better.
 *  http://jqueryboilerplate.com
 *
 *  Made by Juan Lanus
 *  Under MIT License
 */
!function(a,b,c){function d(b,c){this.element=b,this.$element=a(b),this.content=this.$element.children()[0],this.$content=a(this.content),this.settings=a.extend({},g,c),this._defaults=g,this._name=f,a.fn.rt.RT=this,this.init()}function e(){var a={documentNumberEncoded:"2n9d",readerNumberEncoded:"4mkbm",topsMap:[],topsMapIdx:0,topsMapElement:null,scrollData:{},_eat:null,get elementAtTop(){if("object"==typeof this._eat)return this._eat;for(var a=0;this.topsMap[a].top>=b.scrollY;)this._eat=this.topsMap[a].node;return this._eat},set elementAtTop(a){this._eat=a},scrollTimer:null,headerId:{},resizingTimer:null,resizingTimerDelay:777,containerYOffset:0};return a}var f="rt",g={leftTopVisiblePix:{left:222,top:10},smartScrollHeight:333,ssIgnoreClass:"ssIgnore",scrollDuration:555,tallElementLimit:300,scrollTimerDelay:999,actionIds:{sessionStart:0,smartScroll:1,scroll:2,resize:6,followLink:5,openTOC:7,selectTOCLink:8,focusLost:20,focusRegained:21,sessionEnd:25},debug:!1};a.extend(d.prototype,{init:function(){var b=a.fn.rt.RT;b.data=e(),b.data.elementAtTop=this.$content.children()[0],this.buildDocMap(),h(b),i(b),j(b),l(b),m(b),n(b),o(b),p(b),q(b),k(b),b.data.scrollData=this.getLastRecordedPosition(b),b.data.scrollData&&b.scrollToPosition(b.data.scrollData),b.displayProgress()},buildDocMap:function(){function b(d,e,f,g){function h(){var b=m.tagName,c="";if("BR"!==b&&"CODE"!==b&&"COL"!==b&&"A"!==b&&"TD"!==b&&"TH"!==b&&"TBODY"!==b){var d=new Array(2*g).join(" ");"H"===b.substring(0,1)&&(d="++"+d.substring(2));var e=16-d.length-b.length;e=new Array(e>0?e:1).join("_");var f=(n.attr("docPath")+"                         ").substring(0,24);c+=d+m.tagName+e+f,c+="  offsetTop:"+m.offsetTop,n.attr("id")&&(c+="  id:"+n.attr("id"));var h=n.text().substr(0,50).replace(/\r?\n|\r/g," ");h&&(c+="  	"+h),c+="\n",a("#docPathLog").append(c)}}var i=e.children().not("[float=left]").not("[float=right]"),j=i.length,k=0,l=/^[hH][1-6]$/;for(k=0;j>k;k++){var m=i[k],n=a(m);if(l.test(m.tagName)){var o=parseInt(m.tagName.substring(1,2),10);f[o]++;for(var p=o+1;8>p;p++)f[p]=0;f.length=7,c(d,f,m),g=0}else f[g+7]?f[g+7]++:f[g+7]=1;n.attr("docPath",f.toString()),(d.settings.debug||f&&-1!==f.indexOf(",,"))&&h(),b(d,n,f.slice(0),g+1)}}function c(a,b,c){var d=null;return c.id?d=c.id:(d="RT-"+b.slice(0,7).toString().replace(/,/g,"-"),c.id=d),a.data.headerId[b.slice(0,7).toString()]={id:d},d}var d=a.fn.rt.RT;d.data.docMap={};var e=[d.settings.pageNumber,0,0,0,0,0,0],f=d.$content;b(d,f,e,0),this.storeHeaderScrollTops(),d.buildTopsMap()},storeHeaderScrollTops:function(){var b=a.fn.rt.RT;b.data.docMap={};for(var d in b.data.headerId)b.data.headerId[d].offsetTop=b.getRelativeTop(c.getElementById(b.data.headerId[d].id));b.data.headerId[b.content.id]={},b.data.headerId[b.content.id].offsetTop=b.getRelativeTop(b.content)},getLastRecordedPosition:function(a){if(!localStorage)return null;a.data.scrollData={t:-1,dp:a.data.elementAtTop.getAttribute("docpath")};for(var b=localStorage.length-1;b>=0;b--){var c=localStorage.key(b);if("RT-"===c.substring(0,3)){var d=c.split("-");if(3===d.length&&d[1]===a.data.documentNumberEncoded&&d[2]>a.data.scrollData.t){var e=JSON.parse(localStorage.getItem(c));e.dp&&(a.data.scrollData.t=d[2],a.data.scrollData.dp=e.dp)}}}return-1===a.data.scrollData.t&&(a.data.scrollData={t:(new Date).getTime()}),a.writeScrollRecord(a.settings.actionIds.sessionStart),a.data.scrollData},buildTopsMap:function(){var b=a.fn.rt.RT;b.data.topsMap=[];var c,d=a("*",b.$content),e=!1,f=d.length,g=0,h=-1e6;for(g=0;f>g;g++){c=d[g],c.getBoundingClientRect()&&b.data.topsMap.push({node:c,top:b.getRelativeTop(c)});var i=b.data.topsMap.length;b.data.debug&&b.data.topsMap[i-1].top===h&&console.log("top val repeated: "+b.data.topsMap[i-1].node.nodeName+" "+h),b.data.topsMap[i-1].top<h&&(e=!0),h=b.data.topsMap[i-1]}b.data.topsMapIdx=0},scrollToPosition:function(b){function d(b,c){for(var d=a(b),f=d.nextAll(),g=0;g<c.length;g++)f.length>=c[g]&&(d=a(f[c[g]-1]),e.settings.debug&&d.css("border","1px solid blue"),f=d.first().children());return d}var e=a.fn.rt.RT;if(b&&b.dp){var f=null;if(b.id)f=b.id;else{var g=b.dp.split(",").slice(0,7).toString(),h=e.data.headerId[g];if(!h)return null;f=e.data.headerId[g].id}var i=c.getElementById(f);if(i&&b.dp){var j=d(i,b.dp.split(",").slice(7),2e3);e.data.elementAtTop=j[0],e.scrollToElement(j,e.settings.scrollDuration)}}},topsMapGetIdxByElement:function(b){for(var c=a.fn.rt.RT,d=c.data.topsMap.length,e=0,f=c.data.topsMapIdx;!0;f++){if(f>=d&&(f=0),b===c.data.topsMap[f].node)return f;if(e++,e>d)return null}},isBlockElement:function(b){if("HR"===b.tagName)return!1;var c=a(b).css("display");return"block"===c?!0:"list-item"===c?!0:"table"===c?!0:"table-cell"===c?!0:"table-row"===c?!0:"table-row-group"===c?!0:"table-header-group"===c?!0:"flex"===c?!0:"grid"===c?!0:!1},getRelativeTop:function(b){var c=a.fn.rt.RT;return b?b.getBoundingClientRect()?b.getBoundingClientRect().top-c.$element[0].getBoundingClientRect().top:void 0:0},smartScroll:function(b){for(var c,d=!b,e=a.fn.rt.RT,f=e.topsMapGetIdxByElement(e.data.elementAtTop),g=f,h=e.data.topsMap[f].top,i=e.settings.smartScrollHeight*(d?1:.3);;){if(d){if(g++,g>=e.data.topsMap.length)break}else{if(0>=g)break;g--}if(c=e.data.topsMap[g].node,!a(c).hasClass(e.settings.ssIgnoreClass)&&e.isBlockElement(c)){if(/^[hH][1-6]$/.test(c.nodeName))break;if(Math.abs(e.data.topsMap[g].top-h)>i)break}}var j=Math.abs(e.data.topsMap[g].top-h),k=j/e.settings.smartScrollHeight*e.settings.scrollDuration;if(e.settings.debug){var l=e.data.topsMap[g].node;console.log("ss "+(d?"forward  ":"backwards")+" delay:"+k.toFixed()+" to:"+e.data.topsMap[g].top+(e.data.scrollData.p?e.data.scrollData.p+"%":"")+" î‚­:"+j+" topNode"+g+" docPath:"+l.getAttribute("docPath")+" "+l.tagName+(l.getAttribute("id")?" id:"+l.getAttribute("id"):"")+(e.data.scrollData.text?" "+e.data.scrollData.text:""))}return e.data.elementAtTop=c,e.scrollToElement(a(c),k),g},scrollToElement:function(c,d){var e=a.fn.rt.RT;c.addClass("rtScrolltarget"),e.data.disableScrollEvents=!0;var f=e.getRelativeTop(c[0]);a("html, body").scrollTo(f,{duration:d,easing:"swing"},function(){var d=a.fn.rt.RT;d.data.disableScrollEvents=!1,b.setTimeout(function(){c.removeClass("rtScrolltarget")},500)})},displayProgress:function(){var c=a.fn.rt.RT,d=a("#rtProgressDiagram");d.html(a("#rtProgressTemplate").html()),d.addClass("rtProgress");var e=c.element.clientHeight,f=0;c.data.elementAtTop&&(f=c.getRelativeTop(c.data.elementAtTop));var g,h=b.innerHeight;f=Math.round(100*(f/e)),a("#rtProgressDiagram .rtProgressDone").css("height",f+"%").text(10>f?"":f+"%"),h=Math.round(100*(h/e)),1>h&&(h=1),a("#rtProgressDiagram .rtProgressCurrent").css("height",h+"%"),g=100-f-h,a("#rtProgressDiagram .rtProgressRemaining").css("height",g+"%").text(10>g?"":g+"%")},writeScrollRecord:function(b){var c=a.fn.rt.RT;c.data.scrollData.a=b,localStorage&&localStorage.setItem("RT-"+c.data.documentNumberEncoded+"-"+c.data.scrollData.t,JSON.stringify(c.data.scrollData));var d=c.data.scrollData.t.toString(36);d+="-"+c.data.documentNumberEncoded,d+="-"+c.data.readerNumberEncoded,d+="-"+c.data.scrollData.dp+(c.data.scrollData.p?"."+c.data.scrollData.p:""),d+="-"+c.data.scrollData.a,c.settings.debug&&(c.data.scrollData.text?"-"+c.data.scrollData.text:""),console.log("k:RT-"+c.data.documentNumberEncoded+"-"+c.data.scrollData.t+" rec:"+d),a.ajax({type:"PUT",url:"http://localhost:3333/storeActions",contentType:"text/plain",data:d})},getCurrentReadingPosition:function(){for(var b=a.fn.rt.RT,d=c.elementFromPoint(b.settings.leftTopVisiblePix.left,b.settings.leftTopVisiblePix.top),e=0,f=0,g=99999;b.content===d||b.element===d;)if(e+=7,(b.settings.leftTopVisiblePix.left+e>b.$content.innerWidth()||d===b.element)&&(f+=7,e=parseInt(b.$content.css("margin-left").replace(/px/," "),10)),d=c.elementFromPoint(b.settings.leftTopVisiblePix.left+e,b.settings.leftTopVisiblePix.top+f),e>b.content.clientHeight){b.data.debug&&alert("reached bottom of document"),g=-1;break}var h=b.$element.scrollTop();for(var i in b.data.headerId)if(b.data.headerId[i].offsetTop>=h)break;return b.data.scrollData.dp=d.getAttribute("docPath"),null==b.data.scrollData.dp&&b.settings.debug&&console.log("null docPath!"),""!==d.getAttribute("id")&&(b.data.scrollData.id=d.getAttribute("id")),a(d).offset().top<0&&a(d).height()>b.data.tallElementLimit&&(b.data.scrollData.p=Math.round(Math.abs(a(d).offset().top/d.offsetHeight*100))),b.data.scrollData.text=a(d).text().substr(0,50).replace(/\r?\n|\r/g," "),d}});var h=function(a){b.onbeforeunload=function(){a.writeScrollRecord(a.settings.actionIds.sessionEnd)}},i=function(a){a.$element.attr("tabindex","0"),a.$element.focus(),a.$element.on("keydown",null,a,function(a){var b=a.which,c=a.data;32!==b||a.altKey||a.metaKey||a.ctrlKey||(c.data.scrollTimer=null,c.data.scrollData.t=(new Date).getTime(),a.shiftKey?c.smartScroll(!0):c.smartScroll(),a.preventDefault(),a.stopPropagation(),c.data.scrollData.dp=c.writeScrollRecord(c.settings.actionIds.smartScroll),c.displayProgress())})},j=function(c){a(b).on("resize",null,c,function(c){var d=c.data;b.clearTimeout(d.data.resizingTimer),d.data.resizingTimer=b.setTimeout(function(){var b=a.fn.rt.RT;b.data.scrollData.t=(new Date).getTime(),b.writeScrollRecord(b.settings.actionIds.resize),b.data.resizingTimer=null,b.storeHeaderScrollTops,b.buildTopsMap(),b.data.disableScrollEvents=!0,b.scrollToPosition(b.data.scrollData)},d.data.resizingTimerDelay),c.stopPropagation()})},k=function(c){a(b).on("scroll",null,c,function(a){var c=a.data;c.data.disableScrollEvents||(b.clearTimeout(c.scrollTimer),c.data.scrollTimer=b.setTimeout(function(){c.data.scrollData.t=(new Date).getTime();var a=c.getCurrentReadingPosition();c.data.scrollData.dp=a.getAttribute("docpath"),c.data.scrollTimer=null,c.writeScrollRecord(c.settings.actionIds.scroll),c.displayProgress()},c.settings.scrollTimerDelay),a.stopPropagation())})},l=function(a){var b='<div id="rtPanelLeft" class="rtPanelLeft" style="z-index:999;">\n<div id="rtProgressDiagram">\n<img src="res/progressDiagram.png" title="progress diagram (non functional yet), shows the reading place\n and the number of pages alredy read and still pending">\n</div>\n<div id="rtBurgerMenu">\n<img src="./res/iconmenu.png" alt="menu" title="show menu" />\n</div>\n<div id="rtTOCIcon">\n<img src="./res/icontoc.png" alt="TOC button" title="show table of content" />\n</div>\n<div id="rtHighlightIcon">\n<img src="./res/iconhighlight.png" alt="highlight button" title="highlight the selected text" />\n</div>\n<div id="rtHelpIcon">\n<img src="./res/iconhelp2.png" alt="help (pls read)" title="instructions" />\n</div>\n<div id="rtEndTest">\n<button onclick="location.href=\'survey.html\'">End</button>\n</div>\n</div>\n<div id="TOCPanel" style="z-index:998;">\n<div id="TOCContainer"\n<div class="toc">TOC comes here</div>\n</div>\n</div>\n<div id="menuPanel" style="z-index:998;">\n<div id="menuContainer"\n<div class="menu" font-weight:100; class="menu">(replaced by usability test instructions)<br>click again to dimiss</div>\n</div>\n</div>\n<div id="helpPanel" style="z-index:998;">\n<div id="helpContainer"\n<div class="help" class="help">instructions come here</div>\n</div>\n</div>\n';a.$element.prepend(b)},m=function(){if(b.location.search){var c=b.location.search.replace("?","").split("&"),d={};a.each(c,function(a,b){var c=b.split("=");d[c[0]]=c[1]}),console.log(d),localStorage.setItem("instructions"+localStorage.length,JSON.stringify(d))}},n=function(b){var c=a("#helpContainer");c.html(a("#helpContentText").html()),a("#rtHelpIcon").on("click",null,b,function(b){var c=b.data,d=a("#helpPanel"),e=d.width();"none"===d.css("display")?(d.show().animate({left:-e+1},3),d.show().animate({left:0},777)):d.show().animate({left:-e},"fast",function(){d.hide(),c.$content.focus()})}),a("#helpPanel").on("click",null,b,function(b){var c=b.data,d=a("#helpPanel"),e=d.width();return d.show().animate({left:-e},"fast",function(){d.hide(),c.$content.focus()}),b.stopPropagation(),!1})},o=function(d){rangy.init();var e=rangy.createCssClassApplier("rtHigh1");a("#rtHighlightIcon").on("click",null,d,function(a){var d=a.data;e.toggleSelection(),c.selection?c.selection.empty():b.getSelection()&&b.getSelection().removeAllRanges();for(var f=d.$content,g="scroll: ",h="";f.length>0;)h="undefined"==typeof f.attr("id")?"."+f.attr("class"):"#"+f.attr("id"),g=g+" "+f.prop("tagName")+h+":"+f.scrollTop(),f=f.parent();return console.log(g),!1})},p=function(b){a("#rtTOCIcon").on("click",null,b,function(b){var c=b.data,d=a("#TOCPanel"),e=d.width();"none"===d.css("display")?(d.show().animate({left:-e+1},3),d.show().animate({left:0},777)):d.show().animate({left:-e},"fast",function(){d.hide(),c.$content.focus()})}),a("#TOCPanel").on("click",null,b,function(b){var c=b.data,d=a("#TOCPanel"),e=d.width();return d.show().animate({left:-e},"fast",function(){d.hide(),c.$content.focus()}),b.stopPropagation(),!1}),this.TOC.clearTOC(),this.TOC.buildTOC(b.$content.get()[0]),b.debug&&this.TOC.logTOC(),a(".toc").html(this.TOC.render()),this.TOC.makeCollapsible(a(".toc")[0])},q=function(b){a("#menuContainer").html(a("#agendaBody").html()),a("#menuContainer").css("display","block"),a("#rtBurgerMenu").on("click",null,b,function(b){var c=b.data,d=a("#menuPanel"),e=d.width();"none"===d.css("display")?(d.show().animate({left:-e+1},3),d.show().animate({left:0},777)):d.show().animate({left:-e},"fast",function(){d.hide(),c.$content.focus()})})};a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new d(this,b))}),this}}(jQuery,window,document);